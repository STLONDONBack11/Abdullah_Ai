<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ChatOPT with API & Profile</title>
<style>
* {
  box-sizing: border-box;
  margin: 0;
  padding: 0;
  font-family: Inter, sans-serif;
}

html, body {
  overflow-x: hidden; /* Prevent horizontal scroll */
  width: 100%;
  height: 100%;
}

body {
  height: 100vh;
  display: flex;
  background: #202123;
  color: #ececf1;
  overflow-y: hidden;
}

/* Sidebar */
#sidebar {
  width: 60px;
  background: #202123;
  display: flex;
  flex-direction: column;
  transition: width 0.3s, left 0.3s;
  position: relative;
  border-right: 1px solid #fff;
  z-index: 1002;
}

#sidebar.open {
  width: 250px;
  background: #1b1b1f;
  border-right: none;
}

#sidebar header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 20px 15px;
  border-bottom: 1px solid #333;
}

#sidebar header img {
  width: 36px;
  height: 36px;
  cursor: pointer;
}

#sidebar header span {
  transition: opacity 0.3s;
  font-weight: 600;
  font-size: 1.1rem;
  white-space: nowrap;
  opacity: 0;
}

#sidebar.open header span {
  opacity: 1;
}

button.newChat {
  margin: 10px auto;
  padding: 10px;
  border: none;
  border-radius: 999px;
  background: #10a37f;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  width: 36px;
  height: 36px;
  overflow: hidden;
  transition: all 0.3s;
}

button.newChat svg {
  width: 16px;
  height: 16px;
  fill: #fff;
}

button.newChat .chatText {
  white-space: nowrap;
  opacity: 0;
  transition: opacity 0.3s, margin-left 0.3s;
}

#sidebar.open button.newChat {
  width: auto;
  padding: 10px 16px;
  justify-content: flex-start;
}

#sidebar.open button.newChat .chatText {
  opacity: 1;
  margin-left: 8px;
}

#chatList {
  flex: 1;
  overflow-y: auto;
  margin-top: 10px;
  display: flex;
  flex-direction: column;
  gap: 5px;
  padding: 0 10px;
  position: relative;
  transition: opacity 0.3s;
}

#sidebar:not(.open) #chatList {
  display: none;
}

.chatItem {
  background: #2a2b32;
  color: #ececf1;
  padding: 8px 10px;
  border-radius: 8px;
  cursor: pointer;
  font-size: 14px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  position: relative;
}

.chatItem:hover {
  background: #3a3a44;
}

.dotBtn {
  position: absolute;
  top: 50%;
  right: 8px;
  transform: translateY(-50%);
  cursor: pointer;
  user-select: none;
  font-weight: bold;
  color: #ccc;
  transition: color 0.2s;
}

.dotBtn:hover {
  color: #10a37f;
}

.chatOptionsBox {
  position: fixed;
  background: #2a2b32;
  border: 1px solid #565869;
  border-radius: 8px;
  display: none;
  flex-direction: column;
  gap: 5px;
  padding: 5px;
  z-index: 1000;
  min-width: 140px;
}

.chatOptionsBox button {
  background: none;
  border: none;
  color: #fff;
  cursor: pointer;
  text-align: left;
  padding: 6px 10px;
  border-radius: 4px;
  font-size: 14px;
}

.chatOptionsBox button:hover {
  background: #10a37f;
  color: #0d0d0d;
}

/* Profile Section */
#profileSection {
  display: flex;
  align-items: center;
  padding: 10px;
  border-top: 1px solid #444;
  flex-shrink: 0;
  justify-content: center; /* center DP when collapsed */
}

#sidebar.open #profileSection {
  justify-content: flex-start; /* left-align when open */
}

#dp {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  background: #10a37f;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  color: #fff;
  transition: margin 0.3s, transform 0.3s;
}

#sidebar.open #dp {
  margin-left: 0;
}

#sidebar:not(.open) #dp {
  margin: 0 auto;
}

#profileDetails {
  margin-left: 10px;
  display: none;
  flex-direction: column;
}

#profileDetails span {
  font-size: 14px;
}

#profileDetails span:last-child {
  font-size: 12px;
  color: #aaa;
}

#sidebar.open #profileDetails {
  display: flex;
}

/* Buttons */
#createAccountBtn,
#logoutBtn {
  margin: 10px auto;
  padding: 10px 16px;
  border: none;
  border-radius: 20px;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
  display: block;
  width: 80%;
  transition: 0.3s;
}

#createAccountBtn {
  background: #10a37f;
}

#logoutBtn {
  background: #ff4d4d;
}

#logoutBtn:hover {
  background: #ff3333;
}

#sidebar:not(.open) #logoutBtn {
  display: none;
}

#closeSidebarBtn {
  margin: 10px auto 12px auto;
  width: 36px;
  height: 36px;
  border: none;
  border-radius: 50%;
  background: #2a2a33;
  color: #fff;
  font-size: 18px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
}

#sidebar:not(.open) #closeSidebarBtn {
  display: none;
}

/* Main */
#main {
  flex: 1;
  display: flex;
  flex-direction: column;
  width: 100%;
  overflow-x: hidden;
}

#chatHeader {
  padding: 15px 20px;
  border-bottom: 1px solid #333;
  font-size: 1.2rem;
  display: flex;
  align-items: center;
  gap: 10px;
  position: relative;
}

#chatContainer {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.msg {
  max-width: 75%;
  padding: 12px 16px;
  border-radius: 12px;
  word-wrap: break-word;
  white-space: pre-wrap;
}

.user {
  background: #10a37f;
  color: #fff;
  align-self: flex-end;
  border-bottom-right-radius: 4px;
}

.bot {
  background: #2a2b32;
  color: #ececf1;
  align-self: flex-start;
  border-bottom-left-radius: 4px;
}

/* Typing animation */
.typing {
  font-style: italic;
  color: #999;
  align-self: flex-start;
  font-size: 16px;
  display: flex;
  align-items: center;
  gap: 5px;
}

.dot {
  height: 8px;
  width: 8px;
  background: #999;
  border-radius: 50%;
  animation: blink 1s infinite;
}

.dot:nth-child(2) {
  animation-delay: 0.2s;
}

.dot:nth-child(3) {
  animation-delay: 0.4s;
}

@keyframes blink {
  0%, 80%, 100% {
    opacity: 0;
  }
  40% {
    opacity: 1;
  }
}

/* Welcome */
#welcomeSection {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  text-align: center;
  gap: 20px;
  overflow-x: hidden;
}

#startInputBox {
  display: flex;
  align-items: center;
  border: 1px solid #565869;
  border-radius: 30px;
  padding: 8px 12px;
  background: #40414f;
  width: 60%;
  max-width: 500px;
}

#startInputBox input {
  flex: 1;
  border: none;
  background: transparent;
  color: #fff;
  font-size: 16px;
  outline: none;
}

#startInputBox button {
  border: none;
  background: #10a37f;
  color: #fff;
  border-radius: 50%;
  width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.pin-bar {
  display: flex;
  flex-wrap: wrap;
  justify-content: center;
  gap: 10px;
  max-width: 500px;
  overflow-x: hidden;
}

.pin-bar button {
  background: #1a1a1a;
  border: 1px solid #10a37f;
  color: #fff;
  padding: 10px 14px;
  border-radius: 20px;
  cursor: pointer;
  font-size: 14px;
  transition: 0.3s;
  flex: 1 1 calc(50% - 12px);
  max-width: 180px;
}

.pin-bar button:hover {
  background: #10a37f;
  color: #0d0d0d;
}

.pin-bar button.last {
  flex: 1 1 100%;
  max-width: 200px;
}

#inputArea {
  padding: 12px;
  border-top: 1px solid #333;
  background: #202123;
  display: none;
  width: 100%;
}

#inputArea input {
  flex: 1;
  padding: 12px 16px;
  border-radius: 30px;
  border: 1px solid #565869;
  background: #40414f;
  color: #fff;
  outline: none;
}

#inputArea button {
  margin-left: 10px;
  border: none;
  border-radius: 50%;
  width: 36px;
  height: 36px;
  background: #10a37f;
  color: #fff;
  cursor: pointer;
}

.hidden {
  display: none !important;
}

/* Overlay */
#overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 100;
  display: none;
}

#signinBox {
  background: #2a2b32;
  padding: 20px;
  border-radius: 12px;
  width: 300px;
  display: flex;
  flex-direction: column;
  gap: 12px;
}

#signinBox h2 {
  text-align: center;
  margin-bottom: 10px;
}

#signinBox input {
  padding: 10px;
  border-radius: 8px;
  border: none;
  outline: none;
}

#signinBox button {
  padding: 10px;
  border: none;
  border-radius: 8px;
  background: #10a37f;
  color: #fff;
  cursor: pointer;
}

/* Floating New Chat button */
.topRightNewChat {
  position: fixed;
  top: 5px;
  right: 20px;
  padding: 10px 16px;
  border: none;
  border-radius: 20px;
  background: #10a37f;
  color: #fff;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  z-index: 1001;
  box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  transition: 0.3s;
}

.topRightNewChat:hover {
  background: #0e8e6d;
}

/* Mobile */
@media (max-width: 768px) {
  #sidebar {
    position: fixed;
    left: -250px;
    top: 0;
    height: 100%;
    width: 250px;
    transition: left 0.3s;
    z-index: 1002;
  }

  #sidebar.open {
    left: 0;
  }

  #mobileSidebarToggle {
    display: inline-block;
    position: fixed;
    top: 10px;
    left: 10px;
    z-index: 1003;
    background: #202123;
    border: none;
    border-radius: 6px;
    padding: 6px 10px;
    cursor: pointer;
    font-size: 18px;
    color: #fff;
    box-shadow: 0 2px 6px rgba(0, 0, 0, 0.3);
  }

  #main {
    width: 100vw;
    overflow-x: hidden;
  }

  .pin-bar button {
    flex: 1 1 auto;
    max-width: 140px;
  }

  #startInputBox {
    width: 90%;
    max-width: none;
    padding: 8px 12px;
  }

  #startInputBox input {
    font-size: 16px;
    padding: 8px;
  }

  #startInputBox button {
    width: 36px;
    height: 36px;
    flex-shrink: 0;
  }

  #chatHeader {
    display: flex;
    align-items: center;
    gap: 10px;
    padding: 15px 20px 15px 60px;
  }

  #chatHeader span {
    flex: 1;
  }

  #mobileSidebarToggle {
    position: absolute;
    left: 10px;
    top: 20px;
    transform: translateY(-50%);
    display: inline-block;
  }

  #sidebar.open + #mobileSidebarToggle,
  #sidebar.open ~ #mobileSidebarToggle {
    display: none;
  }
}

/* Hide elements when sidebar is collapsed */
#sidebar:not(.open) #logoutBtn,
#sidebar:not(.open) #closeSidebarBtn,
#sidebar:not(.open) #chatList {
  display: none !important;
}
/* Hide mobile sidebar toggle on desktop */
#mobileSidebarToggle {
  display: none;
}

@media (max-width: 768px) {
  #mobileSidebarToggle {
    display: inline-block; /* only visible on mobile */
  }
}



</style>
</head>
<body>

<!-- Sidebar -->
<div id="sidebar">
  <header>
    <img src="ChatGPT Image Aug 24, 2025, 09_33_34 AM.png" id="logo">
  </header>
  <button class="newChat" id="newChatBtn">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16"><path d="M8 1v14M1 8h14" stroke="white" stroke-width="2" stroke-linecap="round"/></svg>
    <span class="chatText">New Chat</span>
  </button>
  <div id="chatList"></div>
  <div id="profileSection">
    <div id="dp">?</div>
    <div id="profileDetails">
      <span id="profileName"></span>
      <span id="profileEmail"></span>
    </div>
  </div>
  <button id="createAccountBtn">Create Account / Sign In</button>
  <button id="logoutBtn">Logout</button>
  <button id="closeSidebarBtn">√ó</button>
</div>

<!-- Mobile Sidebar Toggle -->
<button id="mobileSidebarToggle">‚ò∞</button>

<!-- Main -->
<div id="main">
  <div id="chatHeader">
    <span>ChatOPT</span>
  </div>
  <div id="welcomeSection">
    <h2>What's on your mind today?</h2>
    <div id="startInputBox">
      <input id="startInput" placeholder="Ask me anything...">
      <button id="startSendBtn">‚û§</button>
      

    </div>
    <div class="pin-bar" id="pinBar">
      <button data-msg="Can you create an image for me?">üñº Create Image</button>
      <button data-msg="Please summarize this text.">üìù Summarize</button>
      <button data-msg="I need some advice.">üí° Get Advice</button>
      <button data-msg="Can you analyze some data?">üìä Analyze Data</button>
      <button class="last" data-msg="Show me more features.">‚ú® More</button>
    </div>
  </div>
  <div id="chatContainer" class="hidden"></div>
  <div id="inputArea">
    <input id="input" placeholder="Ask me anything..."/>
    <button id="sendBtn">‚û§</button>
  </div>
</div>

<!-- Floating New Chat button -->
<button id="topRightNewChatBtn" class="topRightNewChat">Ôºã New Chat</button>

<!-- Overlay -->
<div id="overlay">
  <div id="signinBox">
    <h2>Sign In / Create Account</h2>
    <input id="nameInput" placeholder="Full Name">
    <input id="emailInput" placeholder="Email">
    <input id="passwordInput" type="password" placeholder="Password">
    <button id="createBtn">Submit</button>
  </div>
</div>

<script>
const API_KEY = "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";
const API_URL = "https://api.openai.com/v1/chat/completions";

const sidebar=document.getElementById('sidebar');
const mobileToggle=document.getElementById('mobileSidebarToggle');
const logo=document.getElementById('logo');
const closeBtn=document.getElementById('closeSidebarBtn');
const newChatBtn=document.getElementById('newChatBtn');
const chatList=document.getElementById('chatList');
const welcome=document.getElementById('welcomeSection');
const chatContainer=document.getElementById('chatContainer');
const inputArea=document.getElementById('inputArea');
const inputEl=document.getElementById('input');
const sendBtn=document.getElementById('sendBtn');
const logoutBtn=document.getElementById("logoutBtn");
const overlay=document.getElementById("overlay");
const createBtn=document.getElementById("createBtn");
const createAccountBtn=document.getElementById("createAccountBtn");
const dp=document.getElementById("dp");
const profileName=document.getElementById("profileName");
const profileEmail=document.getElementById("profileEmail");

let messages=[]; let chats=[]; let activeChatId=null; let user=null;

// ================= User & Chat Functions =================
function loadUserChats(email){chats=JSON.parse(localStorage.getItem("chat_"+email)||"[]");}
function saveUserChats(){if(user)localStorage.setItem("chat_"+user.email,JSON.stringify(chats));}
function saveChats(){saveUserChats();renderHistory();}

function renderHistory(){
  chatList.innerHTML="";
  chats.forEach(chat=>{
    let div=document.createElement("div");
    div.className="chatItem";
    div.innerText=chat.title;
    div.onclick=()=>loadChat(chat.id);

    let dotBtn=document.createElement("div");
    dotBtn.className="dotBtn"; dotBtn.innerHTML="‚ãÆ";
    let optsBox=document.createElement("div");
    optsBox.className="chatOptionsBox";

    const deleteBtn=document.createElement("button"); deleteBtn.innerText="üóë Delete";
    deleteBtn.onclick=e=>{ e.stopPropagation(); deleteChat(chat.id); optsBox.style.display="none"; }

    const shareBtn=document.createElement("button"); shareBtn.innerText="üîó Share";
    shareBtn.onclick=e=>{ e.stopPropagation(); shareChat(chat.id); optsBox.style.display="none"; }

    const downloadBtn=document.createElement("button"); downloadBtn.innerText="‚¨á Download";
    downloadBtn.onclick=e=>{ e.stopPropagation(); downloadChat(chat.id); optsBox.style.display="none"; }

    optsBox.appendChild(deleteBtn); optsBox.appendChild(shareBtn); optsBox.appendChild(downloadBtn);
    document.body.appendChild(optsBox);

    dotBtn.onclick=e=>{
      e.stopPropagation();
      const rect=dotBtn.getBoundingClientRect();
      optsBox.style.top=rect.top+"px";
      optsBox.style.left=rect.right+5+"px";
      optsBox.style.display=optsBox.style.display==="flex"?"none":"flex";
    };
    document.addEventListener("click",()=>{ optsBox.style.display="none"; });

    div.appendChild(dotBtn);
    chatList.appendChild(div);
  });
}

// ================= Chat Functions =================
logo.addEventListener('mouseenter',()=>sidebar.classList.add('open'));
closeBtn.addEventListener('click',()=>sidebar.classList.remove('open'));
newChatBtn.onclick=()=>startNewChat();
document.getElementById("topRightNewChatBtn").onclick=()=>startNewChat();
document.getElementById('startSendBtn').onclick=()=>firstMessage(document.getElementById('startInput').value);
document.getElementById('startInput').addEventListener('keydown',e=>{if(e.key==='Enter')firstMessage(e.target.value);});
document.querySelectorAll('#pinBar button').forEach(btn=>btn.onclick=()=>firstMessage(btn.dataset.msg));

function firstMessage(text){if(!text.trim())return; startNewChat(); handleUserMessage(text);}
function startNewChat(){messages=[]; activeChatId=Date.now(); chats.push({id:activeChatId,title:"New Chat",messages:[]}); saveChats(); welcome.classList.remove('hidden'); chatContainer.classList.add('hidden'); chatContainer.innerHTML=""; inputArea.style.display="none";}
function loadChat(id){let chat=chats.find(c=>c.id===id);if(!chat)return; activeChatId=id; messages=chat.messages; welcome.classList.add('hidden'); chatContainer.classList.remove('hidden'); inputArea.style.display="flex"; chatContainer.innerHTML=""; messages.forEach(m=>addMessage(m.content,m.role));}
sendBtn.onclick=()=>{if(inputEl.value.trim())handleUserMessage(inputEl.value.trim()); inputEl.value="";};
inputEl.addEventListener("keydown",e=>{if(e.key==="Enter")sendBtn.click();});

async function handleUserMessage(text){
  if(!text.trim())return;
  welcome.classList.add('hidden'); chatContainer.classList.remove('hidden'); inputArea.style.display="flex";
  addMessage(text,"user"); messages.push({role:"user",content:text}); updateChatTitle(); saveMessages();
  addTypingMessage();
  try{
    const res=await fetch(API_URL,{
      method:"POST",
      headers:{"Content-Type":"application/json","Authorization":`Bearer ${API_KEY}`},
      body:JSON.stringify({model:"gpt-4o-mini",messages})
    });
    const data=await res.json();
   removeTypingMessage();
const reply = data.choices[0].message.content;
typeMessage(reply, "bot" , 1); // fast typing
messages.push({role:"assistant", content: reply});
saveMessages();


  }catch(e){ removeTypingMessage(); addMessage("Error: "+e.message,"bot"); }
}

function addMessage(text,role){let div=document.createElement("div"); div.className="msg "+role; div.innerText=text; chatContainer.appendChild(div); chatContainer.scrollTop=chatContainer.scrollHeight; }
function addTypingMessage(){let div=document.createElement("div"); div.className="typing"; div.innerHTML='<div class="dot"></div><div class="dot"></div><div class="dot"></div>'; chatContainer.appendChild(div); chatContainer.scrollTop=chatContainer.scrollHeight; return div; }
function removeTypingMessage(){document.querySelector(".typing")?.remove();}
function updateChatTitle(){let chat=chats.find(c=>c.id===activeChatId); if(chat&&chat.title==="New Chat"&&messages.length>0){chat.title=messages[0].content.slice(0,20)+"..."; saveChats();}}
function saveMessages(){let chat=chats.find(c=>c.id===activeChatId); if(chat){chat.messages=messages; saveChats();}}
function deleteChat(id){chats=chats.filter(c=>c.id!==id); saveChats();}
function downloadChat(id){let chat=chats.find(c=>c.id===id); if(!chat)return; let blob=new Blob([JSON.stringify(chat,null,2)],{type:"application/json"}); let a=document.createElement("a"); a.href=URL.createObjectURL(blob); a.download=`${chat.title.replace(/\s+/g,"_")}.json`; a.click();}
function shareChat(id){let chat=chats.find(c=>c.id===id); if(!chat)return; const chatText=JSON.stringify(chat,null,2); navigator.clipboard.writeText(chatText).then(()=>{alert("Chat copied to clipboard!");}).catch(()=>{alert("Failed to copy chat.");});}

// ================= Account =================
function renderUser(){
  user=JSON.parse(localStorage.getItem("user")||"null");
  if(user){ dp.innerText=user.name[0].toUpperCase(); profileName.innerText=user.name; profileEmail.innerText=user.email; createAccountBtn.style.display="none"; logoutBtn.style.display="block"; loadUserChats(user.email); renderHistory();}
  else{ dp.innerText="?"; profileName.innerText=""; profileEmail.innerText=""; createAccountBtn.style.display="block"; logoutBtn.style.display="none"; chatList.innerHTML=""; }
}
renderUser();
createAccountBtn.onclick=()=>overlay.style.display="flex";
createBtn.onclick=async()=>{
  const name=document.getElementById("nameInput").value.trim();
  const email=document.getElementById("emailInput").value.trim();
  const pass=document.getElementById("passwordInput").value.trim();
  if(!name||!email||!pass){alert("Fill all fields"); return;}
  await new Promise(r=>setTimeout(r,500));
  localStorage.setItem("user",JSON.stringify({name,email}));
  overlay.style.display="none";
  renderUser();
};
logoutBtn.onclick=()=>{localStorage.removeItem("user"); messages=[]; chats=[]; activeChatId=null; chatContainer.innerHTML=""; inputArea.style.display="none"; welcome.classList.remove('hidden'); renderUser();};

// ================= Mobile Sidebar Toggle =================
mobileToggle.addEventListener('click',()=>sidebar.classList.toggle('open'));

function typeMessage(text, role, speed = 30) {
    let div = document.createElement("div");
    div.className = "msg " + role;
    chatContainer.appendChild(div);
    chatContainer.scrollTop = chatContainer.scrollHeight;

    let i = 0;
    let interval = setInterval(() => {
        div.innerText += text[i];
        i++;
        chatContainer.scrollTop = chatContainer.scrollHeight;
        if (i >= text.length) clearInterval(interval);
    }, speed);
}
const imagePreviewContainer = document.getElementById("imagePreviewContainer");
let selectedImageFile = null;

// Show preview when image is selected
imageInput.onchange = (e) => {
    const file = e.target.files[0];
    if (!file) return;
    selectedImageFile = file;

    const reader = new FileReader();
    reader.onload = (ev) => {
        imagePreviewContainer.innerHTML = `<img src="${ev.target.result}" style="max-width:100%; border-radius:8px;">`;
    };
    reader.readAsDataURL(file);
};

// Modify send button to include image
sendBtn.onclick = async () => {
    if (!inputEl.value.trim() && !selectedImageFile) return;

    welcome.classList.add('hidden'); 
    chatContainer.classList.remove('hidden');
    inputArea.style.display = "flex";

    // Show user message
    if (selectedImageFile) {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const imgDiv = document.createElement("div");
            imgDiv.className = "msg user";
            imgDiv.innerHTML = `<img src="${ev.target.result}" style="max-width:100%; border-radius:8px;"><br>${inputEl.value}`;
            chatContainer.appendChild(imgDiv);
            chatContainer.scrollTop = chatContainer.scrollHeight;
        };
        reader.readAsDataURL(selectedImageFile);
    } else {
        addMessage(inputEl.value, "user");
    }

    messages.push({ role: "user", content: inputEl.value });
    saveMessages();

    const typingDiv = addTypingMessage();

    // Prepare form for OpenAI if there's an image
    try {
        let reply = "";
        if (selectedImageFile) {
            const formData = new FormData();
            formData.append("image", selectedImageFile);
            formData.append("prompt", inputEl.value); // question under image
            formData.append("model", "gpt-image-1"); // image model

            const res = await fetch("https://api.openai.com/v1/images/edits", {
                method: "POST",
                headers: { "Authorization": `Bearer ${API_KEY}` },
                body: formData
            });

            const data = await res.json();
            if (data.data && data.data[0] && data.data[0].url) {
                reply = data.data[0].url;
                const imgDiv = document.createElement("div");
                imgDiv.className = "msg bot";
                imgDiv.innerHTML = `<img src="${reply}" style="max-width:100%; border-radius:8px;">`;
                chatContainer.appendChild(imgDiv);
                chatContainer.scrollTop = chatContainer.scrollHeight;
            } else {
                addMessage("Failed to generate image", "bot");
            }
        } else {
            // Text-only message to GPT
            const res = await fetch(API_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${API_KEY}` },
                body: JSON.stringify({ model: "gpt-4o-mini", messages })
            });
            const data = await res.json();
            removeTypingMessage();
            reply = data.choices[0].message.content;
            typeMessage(reply, "bot");
        }

        messages.push({ role: "assistant", content: reply });
        saveMessages();
        removeTypingMessage();

    } catch (err) {
        removeTypingMessage();
        addMessage("Error: " + err.message, "bot");
    }

    // Clear input & preview
    inputEl.value = "";
    imagePreviewContainer.innerHTML = "";
    selectedImageFile = null;
};


</script>
</body>
</html>
